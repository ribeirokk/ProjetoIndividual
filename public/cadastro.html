<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Skyrim | Cadastro</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./css/cadastro.css" />
  <link rel="icon" href="./assets/img/skyrimIcon.png" />
</head>

<body onload="listar()">
  <!--header inicio-->
  <header>
    <nav>
      <a class="logo" href="/">Skyrim</a>

      <ul class="nav-list">
      </ul>

      <div class="nav-action">
        <img class="nav-img" src="./assets/img/imperioIcon.png" alt="icon imperial">
        <a href="login.html" style="display: flex;">
          <button class="nav-button">Já Luta Por Skyrim?</button>
          <img class="nav-img" src="./assets/img/stormcloakIcon.png" alt="icon stormcloak">
        </a>

      </div>
    </nav>
  </header>
  <!--header fim-->

  <div class="login">
    <div class="alerta_erro">
      <div class="card_erro" id="cardErro">
        <span id="mensagem_erro"></span>
      </div>
    </div>
    <div class="formulario">
      <h1>Quem é Você?</h1>
      <h2>Defina sua história</h2>

      <div class="campo">
        <span>Nome:</span>
        <input id="nome_input" type="text" placeholder="Seu nome" />
      </div>

      <div class="campo">
        <span>Idade:</span>
        <input id="idade_input" type="text" placeholder="Insira sua idade aqui" />
      </div>

      <div class="campo">
        <span>Classe:</span>
        <input id="classe_input" type="text" placeholder="Sua Classe" />
      </div>

      <div class="campo">
        <span>Cidade/Vila:</span>
        <input id="lugar_input" type="text" placeholder="Seu lugar" />
      </div>

      <div class="campo">
        <span>Gênero:</span>
        <select id="genero_select">
          <option selected disabled value="#">Selecione seu Gênero</option>
          <option value="homem">Homem</option>
          <option value="mulher">Mulher</option>
          <option value="outro">Outro</option>
        </select>
      </div>
      <div class="campo">
        <span>Raça:</span>
        <select id="raca_select" onchange="trocar()">
          <option selected disabled value="#">Selecione uma raça</option>
          <option value="dunmer">Dunmer</option>
          <option value="altamer">Elfo Negro</option>
          <option value="bosmer">Elfo da Floresta</option>
          <option value="orc">Orc</option>
          <option value="khajiit">Khajiit</option>
          <option value="argoniano">Argoniano</option>
          <option value="imperial">Imperial</option>
          <option value="nordico">Nórdico</option>
          <option value="redguard">Redguard</option>
          <option value="bretao">Bretão</option>
        </select>
      </div>

      <div class="campo">
        <span>Sua Escola de Magia:</span>
        <select id="magia_select">
          <option selected disabled value="#">Selecione uma escola</option>
          <option value="conjuracao">Conjuração</option>
          <option value="ilusao">Ilusão</option>
          <option value="destruicao">Destruição</option>
          <option value="restauracao">Restauração</option>
          <option value="alteracao">Alteração</option>
        </select>
      </div>

      <div class="campo">
        <span>E-mail:</span>
        <input id="email_input" type="text" placeholder="meuemail@provedor.com" />
      </div>

      <div class="campo">
        <span>Senha:</span>
        <input id="senha_input" type="password" placeholder="******" />
      </div>

      <div class="campo">
        <span>Confirmação da Senha:</span>
        <input id="confirmacao_senha_input" type="password" placeholder="******" />
      </div>
      <div class="personagem">
        <img id="personagemImg" src="./assets/img/cadastro/cicero.jpg" alt="">
      </div>
      <button class="botao" onclick="cadastrar()">Cadastrar</button>
      <div id="div_erros_login"></div>
    </div>

    <div class="hadvar">
    </div>

  </div>


  <!--footer inicio-->
  <footer>
    <div class="facecard">
      <img src="./assets/img/face.png" alt="" />
      <h1>Luiz Vittor Marques Ribeiro</h1>
      <p>
        Responsável pelo desenvolvimento frontend e backend do site como projeto
        individual na disciplina de PI na SPTECH.
      </p>
    </div>

    <div class="redes-sociais">
      <img src="./assets/img/linkedin.png" alt="">
      <img src="./assets/img/github.webp" alt="">
      <img src="./assets/img/github.webp" alt="">
    </div>

    <p id="copyright">The Elder Scrolls Skryim is © Copyright 2025 Bethesda</p>
  </footer>

  <!--footer fim-->
</body>

</html>

<script>
function cadastrar() {
  var nomeVar = nome_input.value;
  var idadeVar = idade_input.value;
  var classeVar = classe_input.value;
  var lugarVar = lugar_input.value;
  var generoVar = genero_select.value;
  var racaVar = raca_select.value;
  var magiaVar = magia_select.value;
  var emailVar = email_input.value;
  var senhaVar = senha_input.value;
  var confirmacaoSenhaVar = confirmacao_senha_input.value;

  var faccao = sessionStorage.getItem("faccaoEscolhida");
  console.log("FACCAO (sessionStorage):", faccao); 

  // validações
  if (
    nomeVar == "" || idadeVar == "" || classeVar == "" || lugarVar == "" ||
    generoVar == "" || racaVar == "" || magiaVar == "" || emailVar == "" ||
    senhaVar == "" || confirmacaoSenhaVar == ""
  ) {
    document.querySelector(".alerta_erro").style.display = "flex";
    mensagem_erro.innerHTML = "Preencha todos os campos!";
    setTimeout(sumirMensagem, 4000);
    return false;
  }

  if (!faccao) {
    mensagem_erro.innerHTML = "Escolha uma facção antes de se cadastrar!";
    document.querySelector(".alerta_erro").style.display = "flex";
    setTimeout(sumirMensagem, 4000);
    return false;
  }

  // payload
  var payload = {
    nomeServer: nomeVar,
    idadeServer: idadeVar,
    classeServer: classeVar,
    lugarServer: lugarVar,
    generoServer: generoVar,
    racaServer: racaVar,
    magiaServer: magiaVar,
    emailServer: emailVar,
    senhaServer: senhaVar,
    faccaoServer: faccao
  };

  console.log("PAYLOAD enviar /usuarios/cadastrar:", JSON.stringify(payload)); // <--- log

  fetch("/usuarios/cadastrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(function (resposta) {
    console.log("Resposta do fetch:", resposta);
    if (resposta.ok) {
      document.querySelector(".alerta_erro").style.display = "flex";
      mensagem_erro.innerHTML = "Cadastro realizado com sucesso! Redirecionando para tela de Login...";
      setTimeout(() => { window.location = "login.html"; }, 2000);
      limparFormulario();
    } else {
      resposta.text().then(t => {
        console.error("Erro do servidor:", t);
        mensagem_erro.innerHTML = "Erro ao cadastrar: " + t;
        document.querySelector(".alerta_erro").style.display = "flex";
      });
    }
  })
  .catch(function (erro) {
    console.log("#ERRO fetch:", erro);
    mensagem_erro.innerHTML = "Erro de rede: " + erro;
    document.querySelector(".alerta_erro").style.display = "flex";
  });

  return false;
}
</script>
